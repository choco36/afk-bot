<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Login Only</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>input,select{color:#111!important}.mc{background:#0e0e0f;color:#d7ffd7;border-radius:10px;padding:10px;height:50vh;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace}</style>
</head>
<body class="bg-neutral-100 text-neutral-900 dark:bg-neutral-950 dark:text-neutral-100">
  <div class="max-w-xl mx-auto p-4 space-y-3">
    <div class="panel p-2 border bg-white dark:bg-neutral-900 rounded flex flex-col md:flex-row gap-2 items-stretch mb-3">
      <div class="flex-1 flex items-center gap-2"><span id="lockDotL" class="w-3 h-3 rounded-full bg-red-500"></span><span id="lockTextL" class="text-sm">מצב: נעול – צריך להזין טוקן</span></div>
      <input id="tokenL" class="px-3 py-2 rounded border flex-1" placeholder="ADMIN_TOKEN" />
      <button id="saveTokenL" class="px-3 py-2 rounded bg-blue-600 text-white">שמירה</button>
      <a href="./" class="px-3 py-2 rounded border">חזרה</a>
    </div>

    <form id="loginForm" class="grid gap-2 panel p-3 border bg-white dark:bg-neutral-900 rounded">
      <input id="l_host" class="px-3 py-2 rounded border" placeholder="play.server.com" required />
      <input id="l_port" type="number" value="25565" class="px-3 py-2 rounded border" />
      <select id="l_auth" class="px-3 py-2 rounded border"><option value="microsoft">Microsoft (Online)</option><option value="offline">Offline</option></select>
      <input id="l_username" class="px-3 py-2 rounded border hidden" placeholder="שם משתמש (Offline)"/>
      <button class="px-4 py-2 rounded bg-blue-600 text-white">בצע התחברות</button>
    </form>
    <div id="loginConsole" class="mc">[LOGIN] מוכן.</div>
  </div>
  <script type="module">
    const tokenKey='afk.token', $=s=>document.querySelector(s)
    function setLockL(locked){ $('#lockDotL').className='w-3 h-3 rounded-full '+(locked?'bg-red-500':'bg-green-500'); $('#lockTextL').textContent=locked?'מצב: נעול – צריך להזין טוקן':'מצב: פתוח – מאומת' }
    function withTokenUrl(path){ const t=localStorage.getItem(tokenKey); if(!t) return path; const sep=path.includes('?')?'&':'?'; return path+sep+'token='+encodeURIComponent(t) }
    function authHeaders(){ const t=localStorage.getItem(tokenKey); return t?{'Authorization':'Bearer '+t}:{ } }
    async function setServerCookieFromToken(){ const t=(localStorage.getItem(tokenKey)||'').trim(); if(!t) return; try{ await fetch('/api/set-token',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:t})}) }catch{} }
    async function checkL(){ await setServerCookieFromToken(); try{ const r=await fetch(withTokenUrl('/api/me'),{headers:authHeaders()}); const d=await r.json(); setLockL(!d.authorized) }catch{ setLockL(true) } }
    document.getElementById('saveTokenL').onclick=async()=>{ localStorage.setItem(tokenKey, (document.getElementById('tokenL').value||'').trim()); await checkL(); alert('נשמר') }
    const urlTok=new URLSearchParams(location.search).get('token'); if(urlTok){ localStorage.setItem(tokenKey, urlTok.trim()) }
    checkL()

    const apiCreate= async cfg => { const headers={'Content-Type':'application/json', ...(localStorage.getItem(tokenKey)?{'Authorization':'Bearer '+localStorage.getItem(tokenKey)}:{})}; const r=await fetch(withTokenUrl('/api/sessions'),{method:'POST',headers, body:JSON.stringify(cfg)}); if(r.status===401) throw new Error('צריך להזין ADMIN_TOKEN (Unauthorized)'); if(!r.ok) throw new Error((await r.json()).error||r.statusText); return r.json() }
    document.getElementById('l_auth').onchange=()=> document.getElementById('l_username').classList.toggle('hidden', document.getElementById('l_auth').value!=='offline')
    document.getElementById('loginForm').onsubmit=async e=>{
      e.preventDefault(); const cfg={ host:document.getElementById('l_host').value.trim(), port:Number(document.getElementById('l_port').value||25565), auth:document.getElementById('l_auth').value, username:document.getElementById('l_auth').value==='offline'?document.getElementById('l_username').value.trim():undefined, loginOnly:true, autoReconnect:false }
      const box=document.getElementById('loginConsole'); box.textContent+='\n[LOGIN] Connecting…'
      try{ const {id}=await apiCreate(cfg); box.textContent+='\n[LOGIN] id '+id }catch(e2){ box.textContent+='\n[ERROR] '+(e2?.message||e2) }
    }
  </script>
</body>
</html>
